{% extends "base.html" %}

{% block title %}Chat - Local AI Chatbot{% endblock %}

{% block content %}
<div class="card" style="margin-bottom: 0;">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h5 style="margin: 0;">üí¨ Chat with AI</h5>
            {% if current_user.preferences %}
                <small style="opacity: 0.8;">Personalized for {{ current_user.preferences.get_preference('display_name', current_user.username) }}</small>
            {% endif %}
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <a href="{{ url_for('chat.chat_history') }}" class="nav-link" style="padding: 0.5rem; color: white; background: rgba(255,255,255,0.2); border-radius: 0.5rem;">
                üìù
            </a>
            <a href="{{ url_for('auth.preferences') }}" class="nav-link" style="padding: 0.5rem; color: white; background: rgba(255,255,255,0.2); border-radius: 0.5rem;">
                ‚öôÔ∏è
            </a>
        </div>
    </div>
    
    <div class="chat-container" id="chatMessages">
        {% if chat_history %}
            {% for message in chat_history %}
                <div style="display: flex; margin-bottom: 1rem; {% if loop.index0 % 2 == 0 %}justify-content: flex-end;{% endif %}">
                    <div class="message-bubble {% if loop.index0 % 2 == 0 %}user-message{% else %}bot-message{% endif %}">
                        {% if loop.index0 % 2 == 0 %}
                            {{ message.user_message }}
                        {% else %}
                            {{ message.bot_response }}
                        {% endif %}
                        <div style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.7;">
                            {{ message.timestamp.strftime('%H:%M') }}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div style="text-align: center; padding: 2rem; color: #6c757d;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">ü§ñ</div>
                <h6>Start your first conversation!</h6>
                <p style="margin: 0;">Your AI assistant is ready to chat. All messages are encrypted and private.</p>
            </div>
        {% endif %}
        
        <!-- Typing Indicator -->
        <div id="typingIndicator" style="display: none; margin-bottom: 1rem;">
            <div class="message-bubble bot-message" style="background: #f8f9fa;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="spinner" style="width: 15px; height: 15px; border-width: 2px;"></div>
                    <span style="color: #6c757d;">AI is thinking...</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="chat-input-area">
        <form id="chatForm" class="chat-input-form">
            {{ form.hidden_tag() }}
            <textarea 
                id="messageInput" 
                name="message"
                class="form-control chat-input" 
                placeholder="Type your message..." 
                rows="1"
                required
            ></textarea>
            <button type="submit" class="btn btn-primary send-btn" id="sendBtn">
                <span id="sendIcon">üì§</span>
            </button>
        </form>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; font-size: 0.8rem; color: #6c757d;">
            <span>üîí Encrypted & Private</span>
            <button type="button" onclick="clearHistory()" style="background: none; border: none; color: #dc3545; font-size: 0.8rem; cursor: pointer;">
                üóëÔ∏è Clear History
            </button>
        </div>
    </div>
</div>

<!-- Clear History Modal -->
<div id="clearModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px;">
        <div class="card">
            <div class="card-header">
                <h6>üóëÔ∏è Clear Chat History</h6>
            </div>
            <div class="card-body">
                <p>Are you sure you want to clear all your chat history? This action cannot be undone.</p>
                <div class="alert alert-danger">
                    <strong>‚ö†Ô∏è Warning:</strong> This will permanently delete all your encrypted conversations.
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button onclick="closeClearModal()" class="btn btn-secondary" style="flex: 1;">
                        Cancel
                    </button>
                    <form method="POST" action="{{ url_for('chat.clear_history') }}" style="flex: 1;">
                        {{ csrf_token() }}
                        <button type="submit" class="btn btn-danger" style="width: 100%;">
                            Clear All
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const sendIcon = document.getElementById('sendIcon');
    const chatMessages = document.getElementById('chatMessages');
    const typingIndicator = document.getElementById('typingIndicator');
    
    // Auto-resize textarea for mobile
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Handle Enter key (Shift+Enter for new line)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (this.value.trim()) {
                chatForm.dispatchEvent(new Event('submit'));
            }
        }
    });
    
    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Disable form
        sendBtn.disabled = true;
        sendBtn.classList.add('loading');
        sendIcon.innerHTML = '<div class="spinner"></div>';
        messageInput.disabled = true;
        
        // Add user message to chat
        addMessage(message, 'user');
        
        // Show typing indicator
        typingIndicator.style.display = 'block';
        scrollToBottom();
        
        // Clear input
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        // Send request
        const formData = new FormData(chatForm);
        formData.set('message', message);
        
        fetch('{{ url_for("chat.send_message") }}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            typingIndicator.style.display = 'none';
            
            if (data.success) {
                addMessage(data.bot_response, 'bot', data.timestamp);
            } else {
                addMessage('Sorry, there was an error processing your message. Please try again.', 'bot');
            }
        })
        .catch(error => {
            typingIndicator.style.display = 'none';
            addMessage('Connection error. Please check your internet connection and try again.', 'bot');
        })
        .finally(() => {
            sendBtn.disabled = false;
            sendBtn.classList.remove('loading');
            sendIcon.innerHTML = 'üì§';
            messageInput.disabled = false;
            messageInput.focus();
        });
    });
    
    function addMessage(text, sender, timestamp = null) {
        const messageContainer = document.createElement('div');
        messageContainer.style.cssText = `
            display: flex; 
            margin-bottom: 1rem; 
            ${sender === 'user' ? 'justify-content: flex-end;' : ''}
        `;
        
        const messageBubble = document.createElement('div');
        messageBubble.className = `message-bubble ${sender}-message`;
        
        const messageText = document.createElement('div');
        messageText.textContent = text;
        messageBubble.appendChild(messageText);
        
        if (timestamp || sender === 'user') {
            const timeDiv = document.createElement('div');
            timeDiv.style.cssText = 'font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.7;';
            timeDiv.textContent = timestamp || new Date().toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            messageBubble.appendChild(timeDiv);
        }
        
        messageContainer.appendChild(messageBubble);
        chatMessages.insertBefore(messageContainer, typingIndicator);
        
        scrollToBottom();
    }
    
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Initial scroll to bottom
    scrollToBottom();
    
    // Focus on input for better mobile UX
    messageInput.focus();
});

function clearHistory() {
    document.getElementById('clearModal').style.display = 'block';
}

function closeClearModal() {
    document.getElementById('clearModal').style.display = 'none';
}

// Close modal on outside click
document.getElementById('clearModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeClearModal();
    }
});
</script>
{% endblock %}